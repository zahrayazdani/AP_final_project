#include <sstream>
#include "CommandHandler.h"
#include "Controller.h"
#include "Data.h"
#include "Printer.h"
#include "Exceptions.h"
#include "User.h"
#include "Publisher.h"
#include "Film.h"
#include "Recommender.h"

using namespace std;

CommandHandler::CommandHandler()
{
	data = new Data;
	controller = new Controller(data);
	printer = new Printer;
	recommender = new Recommender(data);
}

void CommandHandler::handle_command(map<string, string> _curr_command)
{
	curr_command = _curr_command;
	if (curr_command.size() == 0)
		return;
	if (curr_command.find(POST) != curr_command.end())
		handle_post_commands();
	else if (curr_command.find(PUT) != curr_command.end()) 
		handle_put_commands();
	else if (curr_command.find(DELETE) != curr_command.end()) 
		handle_delete_commands();
	else if (curr_command.find(GET) != curr_command.end()) 
		handle_get_commands();
	else
		throw BadRequest();
}

void CommandHandler::handle_post_commands()
{
	string command = curr_command[POST];
	if (command == SIGNUP)
	{
		controller->control_signup(curr_command);
		signup();
	}
	else if (command == LOGIN)
	{
		controller->control_login(curr_command);
		login();
	}
	else if (command == FILMS)
	{
		controller->control_add_film(curr_command);
		add_film();
	}
	else if (command == MONEY)
	{
		handle_post_money_commands();
	}
	else if (command == REPLIES)
	{
		controller->control_reply(curr_command);
		reply();
	}
	else if (command == FOLLOWERS)
	{
		controller->control_follow(curr_command);
		follow();
	}
	else if (command == BUY)
	{
		controller->control_buy(curr_command);
		buy();
	}
	else if (command == RATE)
	{
		controller->control_rate(curr_command);
		rate();
	}
	else if (command == COMMENTS)
	{
		controller->control_comment(curr_command);
		comment();
	}
	else
		throw NotFound();
	printer->print_success_message();
}

void CommandHandler::handle_post_money_commands()
{
	if (curr_command.find(AMOUNT) == curr_command.end())
	{
		controller->control_get_money_from_network(curr_command);
		get_money_from_network();
	}
	else
	{
		controller->control_charge_account(curr_command);
		charge_account();
	}
}

void CommandHandler::handle_put_commands()
{
	if (curr_command[PUT] == FILMS)
	{
		controller->control_edit_film(curr_command);
		edit_film();
	}
	else
		throw NotFound();
	printer->print_success_message();
}

void CommandHandler::handle_delete_commands()
{
	if (curr_command[DELETE] == FILMS)
	{
		controller->control_delete_film(curr_command);
		delete_film();
	}
	else if (curr_command[DELETE] == COMMENTS)
	{
		controller->control_delete_comment(curr_command);
		delete_comment();
	}
	else
		throw NotFound();
	printer->print_success_message();
}

void CommandHandler::handle_get_commands()
{
	string command = curr_command[GET];
	if (command == FOLLOWERS)
	{
		controller->control_get_followers(curr_command);
		printer->print_followers(get_followers());
	}
	else if (command == PUBLISHED)
	{
		controller->control_get_published_films(curr_command);
		printer->print_films(get_published_films());
	}
	else if (command == FILMS)
	{
		handle_get_films_commands();
	}
	else if (command == PURCHASED)
	{
		controller->control_get_bought_films(curr_command);
		printer->print_films(get_bought_films());
	}
	else if (command == NOTIFS)
	{
		controller->control_get_notifs(curr_command);
		printer->print_notifs(get_notifs());
	}
	else if (command == READ_NOTIFS)
	{
		controller->control_get_read_notifs(curr_command);
		printer->print_read_notifs(get_read_notifs(), stoi(curr_command[LIMIT]));
	}
	else
		throw NotFound();
}

void CommandHandler::handle_get_films_commands()
{
	if (curr_command.find(FILM_ID) == curr_command.end())
	{
		controller->control_search(curr_command);
		printer->print_films(search());
	}
	else
	{
		controller->control_show_film_details(curr_command);
		printer->print_film_details(data->find_film(stoi(curr_command[FILM_ID])));
		printer->print_recommend_films(recommender->recommend_film(data->get_active_user(), 
			data->find_film(stoi(curr_command[FILM_ID]))));
	}
}

void CommandHandler::signup()
{
	curr_command[USER_ID] = to_string(data->get_new_user_id());
	User* new_user;
	if ((curr_command.find(PUBLISHER) != curr_command.end()) && (curr_command[PUBLISHER] == _TRUE))
		new_user = new Publisher(curr_command);
	else
	{
		curr_command[PUBLISHER] = _FALSE;
		new_user = new User(curr_command);
	}
	data->add_new_user(new_user);
	data->change_active_user(new_user);
}

void CommandHandler::login()
{
	User* new_login = data->find_user(curr_command[USERNAME]);
	data->change_active_user(new_login);
}

void CommandHandler::add_film()
{
	curr_command[FILM_ID] = to_string(data->get_new_film_id());
	Film* new_film = ((Publisher*)(data->get_active_user()))->add_film(curr_command);
	data->add_new_film(new_film);
}

void CommandHandler::reply()
{
	((Publisher*)(data->get_active_user()))->reply_comment(curr_command);
}

void CommandHandler::follow()
{
	User* curr_user = data->get_active_user();
	stringstream notif;
	notif << "User " << curr_user->get_username() << " with id "  << curr_user->get_id() <<
		 " follow you.";
	if (curr_user->follow((Publisher*)(data->find_user(stoi(curr_command[USER_ID])))))
		data->find_user(stoi(curr_command[USER_ID]))->add_new_notif(notif.str());
}

void CommandHandler::rate()
{
	data->get_active_user()->rate_film(stoi(curr_command[FILM_ID]), stoi(curr_command[SCORE]));	
}

void CommandHandler::comment()
{
	data->get_active_user()->comment(stoi(curr_command[FILM_ID]), curr_command[CONTENT]);
}

void CommandHandler::charge_account()
{
	data->get_active_user()->charge_account(stoi(curr_command[AMOUNT]));
}

void CommandHandler::edit_film()
{
	((Publisher*)(data->get_active_user()))->edit_film(curr_command);
}

void CommandHandler::delete_film()
{
	((Publisher*)(data->get_active_user()))->delete_film(stoi(curr_command[FILM_ID]));
}

void CommandHandler::delete_comment()
{
	((Publisher*)(data->get_active_user()))->delete_comment(stoi(curr_command[FILM_ID]), 
		stoi(curr_command[COMMENT_ID]));
}

void CommandHandler::buy()
{
	Film* film = data->find_film(stoi(curr_command[FILM_ID]));
	string notif = data->get_active_user()->buy_new_film(film);
	if (notif != EMPTY_STRING)
	{
		User* publisher = data->increase_network_money(stoi(curr_command[FILM_ID]));
		publisher->add_new_notif(notif);
	}
}

void CommandHandler::get_money_from_network()
{
	int money = ((Publisher*)(data->get_active_user()))->get_money_from_network();
	data->decrease_network_money(money);
}

vector<FollowersInfo> CommandHandler::get_followers()
{
	return ((Publisher*)(data->get_active_user()))->get_followers();
}

vector<FilmInfo> CommandHandler::get_published_films()
{
	return ((Publisher*)(data->get_active_user()))->get_published_films(curr_command);
}

vector<FilmInfo> CommandHandler::get_bought_films()
{
	return data->get_active_user()->get_bought_films(curr_command);
}

vector<string> CommandHandler::get_notifs()
{
	return data->get_active_user()->get_notifs();
}

vector<FilmInfo> CommandHandler::search()
{
	return data->search(curr_command);	
}

vector<string> CommandHandler::get_read_notifs()
{
	return data->get_active_user()->get_read_notifs();
}#include "CommandParser.h"
#include "define.h"
#include "Exceptions.h"

using namespace std;

map<string, string> CommandParser::parse_command(string command)
{
	vector<string> parsed_command;
	size_t first_char = command.find_first_not_of(SPACE);
	size_t first_space_after_word = command.find_first_of(SPACE, first_char);
	string word;

	while(first_char != string::npos)
	{
		word = command.substr(first_char, first_space_after_word - first_char);
		if ((word == READ) && (parsed_command[parsed_command.size() - 1]) == NOTIFS)
			parsed_command[parsed_command.size() - 1] += READ;
		else if (word != QUESTION_MARK)
			parsed_command.push_back(word);
		command.erase(0, first_space_after_word);
		first_char = command.find_first_not_of(SPACE);
		first_space_after_word = command.find_first_of(SPACE, first_char);
	}

	if (parsed_command.size() % 2)
		throw BadRequest();
	return change_vector_to_map(parsed_command);
}

map<string, string> CommandParser::change_vector_to_map(vector<string> vector)
{
	map<string, string> map;

	for (int i = 0; i < vector.size(); i = i + 2)
		map[vector[i]] = vector[i + 1];

	return map;
}#include "Comment.h"

using namespace std;

Comment::Comment(int _id, string _writer, string _content)
{
	id = _id;
	writer = _writer;
	content = _content;
	deleted = false;
}

int Comment::get_id()
{
	return id;
}

void Comment::add_reply(string reply_message)
{
	replies.push_back(reply_message);
}

string Comment::get_writer()
{
	return writer;
}

void Comment::change_delete_stat()
{
	deleted = true;
}

bool Comment::is_deleted()
{
	return deleted;
}

CommentInfo Comment::set_info()
{
	CommentInfo info;
	info.id = id;
	info.content = content;
	info.replies = replies;
	return info;
}#include "Controller.h"
#include "Data.h"
#include "Exceptions.h"
#include "User.h"
#include "define.h"
#include "Publisher.h"
#include "Film.h"

using namespace std;

Controller::Controller(Data* _data)
{
	data = _data;
}

void Controller::control_signup(map<string, string> command)
{
	if ((command.find(USERNAME) == command.end()) ||
		(command.find(PASSWORD) == command.end()) ||
		(command.find(EMAIL) == command.end()) || 
		(command.find(AGE) == command.end()))
		throw BadRequest();
	check_if_number(command[AGE]);
	if (data->find_user(command[USERNAME]) != NULL)
		throw BadRequest();
	if (command.size() > 6)
		throw BadRequest();
	if ((command.size() == 6) && (command.find(PUBLISHER) == command.end()))
		throw BadRequest();
	check_validataion_of_email(command[EMAIL]);
	if ((command.find(PUBLISHER) != command.end()) && ((command[PUBLISHER] != _TRUE) &&
		(command[PUBLISHER] != _FALSE)))
		throw BadRequest();
}

void Controller::check_validataion_of_email(string email)
{
	if (email.find(AT) == string::npos)
		throw BadRequest();
	if (email.find(DOT, email.find(AT) + 1) == string::npos)
		throw BadRequest();
}

void Controller::control_login(map<string, string> command)
{
	if ((command.find(USERNAME) == command.end()) ||
		(command.find(PASSWORD) == command.end()))
		throw BadRequest();
	if (!data->find_user(command[USERNAME]))
		throw NotFound();
	if (command.size() > 3)
		throw BadRequest();
	if (!data->find_user(command[USERNAME])->check_password(command[PASSWORD]))
		throw BadRequest();
}

void Controller::control_add_film(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (!data->get_active_user()->is_publisher())
		throw PermissionDenied();
	if ((command.find(NAME) == command.end()) ||
		(command.find(YEAR) == command.end()) ||
		(command.find(LENGTH) == command.end()) || 
		(command.find(PRICE) == command.end()) ||
		(command.find(SUMMARY) == command.end()) ||
		(command.find(DIRECTOR) == command.end()))
		throw BadRequest();
	if (command.size() > 7)
		throw BadRequest();
	check_if_number(command[YEAR]);
	check_if_number(command[LENGTH]);
	check_if_number(command[PRICE]);
	if (((Publisher*)(data->get_active_user()))-> find_published_film(command[NAME]) != NULL)
		throw BadRequest();
}

void Controller::control_reply(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (!data->get_active_user()->is_publisher())
		throw PermissionDenied();
	if ((command.find(FILM_ID) == command.end()) ||
		(command.find(COMMENT_ID) == command.end()) ||
		(command.find(CONTENT) == command.end()))
		throw BadRequest();
	if (command.size() > 4)
		throw BadRequest();
	check_if_number(command[FILM_ID]);
	check_if_number(command[COMMENT_ID]);
	if (data->find_film(stoi(command[FILM_ID])) == NULL)
		throw NotFound();
	if (((Publisher*)(data->get_active_user()))->find_published_film(stoi(command[FILM_ID])) == NULL)
		throw PermissionDenied();
	if (((Publisher*)(data->get_active_user()))->find_published_film(stoi(command[FILM_ID]))
		->find_comment(stoi(command[COMMENT_ID])) == NULL)
		throw NotFound();
}

void Controller::control_follow(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (command.find(USER_ID) == command.end())
		throw BadRequest();
	if (command.size() > 2)
		throw BadRequest();
	check_if_number(command[USER_ID]);
	if (data->find_user(stoi(command[USER_ID])) == NULL)
		throw NotFound();
	if (!data->find_user(stoi(command[USER_ID]))->is_publisher())
		throw PermissionDenied();
}

void Controller::control_rate(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if ((command.find(FILM_ID) == command.end()) ||
		(command.find(SCORE) == command.end()))
		throw BadRequest();
	if (command.size() > 3)
		throw BadRequest();
	check_if_number(command[FILM_ID]);
	check_if_number(command[SCORE]);
	if ((stoi(command[SCORE]) > MAX_SCORE) || (stoi(command[SCORE]) < MIN_SCORE))
		throw BadRequest();
	does_user_have_the_film(stoi(command[FILM_ID]));
}

void Controller::control_comment(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if ((command.find(FILM_ID) == command.end()) ||
		(command.find(CONTENT) == command.end()))
		throw BadRequest();
	if (command.size() > 3)
		throw BadRequest();
	check_if_number(command[FILM_ID]);
	does_user_have_the_film(stoi(command[FILM_ID]));
}

void Controller::does_user_have_the_film(int film_id)
{
	if (data->find_film(film_id) == NULL)
		throw NotFound();
	if (data->get_active_user()->find_film(film_id) == NULL)
		throw PermissionDenied();
}

void Controller::control_edit_film(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (!data->get_active_user()->is_publisher())
		throw PermissionDenied();
	if (command.find(FILM_ID) == command.end())
		throw BadRequest();
	if (command.size() > 7)
		throw BadRequest();
	check_if_number(command[FILM_ID]);
	check_edit_film_optional_datas(command);
	if (data->find_film(stoi(command[FILM_ID])) == NULL)
		throw NotFound();
	if (((Publisher*)(data->get_active_user()))->find_published_film(stoi(command[FILM_ID])) == NULL)
		throw PermissionDenied();
}

void Controller::check_edit_film_optional_datas(map<string, string> command)
{
	for (map<string, string>::iterator it = next(command.begin(), 2); it != command.end(); ++it)
	{
		if ((it->first != NAME) && (it->first != YEAR) && (it->first != LENGTH) &&
			(it->first != SUMMARY) && (it->first != DIRECTOR))
			throw BadRequest();
		if (it->first == YEAR)
			check_if_number(it->second);
		if (it->first == LENGTH)
			check_if_number(it->second);
	}
}

void Controller::control_delete_film(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (!data->get_active_user()->is_publisher())
		throw PermissionDenied();
	if (command.find(FILM_ID) == command.end())
		throw BadRequest();
	if (command.size() > 2)
		throw BadRequest();
	check_if_number(command[FILM_ID]);
	if (data->find_film(stoi(command[FILM_ID])) == NULL)
		throw NotFound();
	if (((Publisher*)(data->get_active_user()))-> find_published_film(stoi(command[FILM_ID])) == NULL)
		throw PermissionDenied();
}

void Controller::control_delete_comment(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (!data->get_active_user()->is_publisher())
		throw PermissionDenied();
	if ((command.find(FILM_ID) == command.end()) ||
		(command.find(COMMENT_ID) == command.end()))
		throw BadRequest();
	if (command.size() > 3)
		throw BadRequest();
	check_if_number(command[FILM_ID]);
	check_if_number(command[COMMENT_ID]);
	if (data->find_film(stoi(command[FILM_ID])) == NULL)
		throw NotFound();
	if (((Publisher*)(data->get_active_user()))->find_published_film(stoi(command[FILM_ID])) == NULL)
		throw PermissionDenied();
	if (((Publisher*)(data->get_active_user()))->find_published_film(stoi(command[FILM_ID]))
		->find_comment(stoi(command[COMMENT_ID])) == NULL)
		throw NotFound();
}

void Controller::control_get_followers(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (!data->get_active_user()->is_publisher())
		throw PermissionDenied();
}

void Controller::control_get_published_films(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (!data->get_active_user()->is_publisher())
		throw PermissionDenied();
	if (command.size() > 7)
		throw BadRequest();
	check_search_films_optional_datas(command);
}

void Controller::check_search_films_optional_datas(map<string, string> command)
{
	for (map<string, string>::iterator it = next(command.begin(), 1); it != command.end(); ++it)
	{
		if ((it->first != NAME) && (it->first != MINRATE) && (it->first != MAXYEAR) &&
			(it->first != MINYEAR) && (it->first != PRICE) && (it->first != DIRECTOR))
			throw BadRequest();
		if (it->first == MINRATE)
			check_if_number(it->second);
		if (it->first == MAXYEAR)
			check_if_number(it->second);
		if (it->first == MINYEAR)
			check_if_number(it->second);
		if (it->first == PRICE)
			check_if_number(it->second);
	}
}

void Controller::control_get_bought_films(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (command.size() > 6)
		throw BadRequest();
	check_get_bought_films_optional_datas(command);
}

void Controller::check_get_bought_films_optional_datas(map<string, string> command)
{
	for (map<string, string>::iterator it = next(command.begin(), 1); it != command.end(); ++it)
	{
		if ((it->first != NAME) && (it->first != MAXYEAR) && (it->first != MINYEAR) &&
			(it->first != PRICE) && (it->first != DIRECTOR))
			throw BadRequest();
		if (it->first == MAXYEAR)
			check_if_number(it->second);
		if (it->first == MINYEAR)
			check_if_number(it->second);
		if (it->first == PRICE)
			check_if_number(it->second);
	}
}

void Controller::control_get_notifs(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (command.size() > 1)
		throw BadRequest();
}

void Controller::control_get_read_notifs(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (command.find(LIMIT) == command.end())
		throw BadRequest();
	if (command.size() > 2)
		throw BadRequest();
}

void Controller::control_get_money_from_network(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (!data->get_active_user()->is_publisher())
		throw PermissionDenied();
	if (command.size() > 1)
		throw BadRequest();
}

void Controller::control_charge_account(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (command.size() > 2)
		throw BadRequest();
	check_if_number(command[AMOUNT]);
}

void Controller::control_search(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (command.size() > 7)
		throw BadRequest();
	check_search_films_optional_datas(command);
}

void Controller::control_show_film_details(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (command.size() > 2)
		throw BadRequest();
	check_if_number(command[FILM_ID]);
	if (data->find_film(stoi(command[FILM_ID])) == NULL)
		throw NotFound();
}

void Controller::control_buy(map<string, string> command)
{
	if (data->get_active_user() == NULL)
		throw PermissionDenied();
	if (command.find(FILM_ID) == command.end())
		throw BadRequest();
	if (command.size() > 2)
		throw BadRequest();
	check_if_number(command[FILM_ID]);
	if (data->find_film(stoi(command[FILM_ID])) == NULL)
		throw NotFound();
	if (!data->get_active_user()->
		check_can_buy_film(data->find_film(stoi(command[FILM_ID]))->get_price()))
		throw PermissionDenied();
}

void Controller::check_if_number(string str)
{
	for (int i = 0; i < str.size(); i++)
		if ((str[i] < ASCII_ZERO) || (str[i] > ASCII_NINE))
			throw BadRequest();
}#include "Data.h"
#include "User.h"
#include "Film.h"
#include "Publisher.h"

using namespace std;

Data::Data()
{
	user_id = FIRST_ID;
	film_id = FIRST_ID;
	network_money = 0;
	active_user = NULL;
}

User* Data::find_user(string username)
{
	for (int i = 0; i < users.size(); i++)
		if (users[i]->get_username() == username)
			return users[i];
	return NULL;
}

User* Data::find_user(int id)
{
	for (int i = 0; i < users.size(); i++)
		if (users[i]->get_id() == id)
			return users[i];
	return NULL;
}

Film* Data::find_film(int id)
{
	for (int i = 0; i < films.size(); i++)
		if ((films[i]->get_id() == id) && (!films[i]->is_deleted()))
			return films[i];
	return NULL;
}

User* Data::get_active_user()
{
	return active_user;
}

void Data::change_active_user(User* new_active_user)
{
	active_user = new_active_user;
}

void Data::add_new_user(User* new_user)
{
	users.push_back(new_user);
}

int Data::get_new_user_id()
{
	user_id++;
	return user_id;
}

int Data::get_new_film_id()
{
	film_id++;
	return film_id;
}

void Data::add_new_film(Film* new_film)
{
	films.push_back(new_film);
}

User* Data::increase_network_money(int film_id)
{
	string publisher_username = find_film(film_id)->get_publisher_username();
	int film_price = find_film(film_id)->get_price();
	float film_rate = find_film(film_id)->get_rate();
	network_money += film_price;
	((Publisher*)(find_user(publisher_username)))->increase_debt(film_price, film_rate);
	return find_user(publisher_username);
}

void Data::decrease_network_money(int money)
{
	network_money -= money;
}

vector<FilmInfo> Data::search(map<string, string> info)
{
	vector<FilmInfo> films_info;
	for (int i = 0; i < films.size(); i++)
		if (films[i]->is_in_range(info) && (!films[i]->is_deleted()))
			films_info.push_back(films[i]->set_info());
	return films_info;
}

vector<Film*> Data::get_films()
{
	return films;
}#include <iostream>
#include "Exceptions.h"
#include "define.h"

using namespace std;

const char* NotFound::what() const throw()
{
	return NOTFOUND;
}

const char* BadRequest::what() const throw()
{
	return BADREQUEST;
}

const char* PermissionDenied::what() const throw()
{
	return PERMISSIONDENIED;
}#include <iostream>
#include "Exceptions.h"
#include "Film.h"
#include "Comment.h"

using namespace std;

Film::Film(map<string, string> info)
{
	name = info[NAME];
	year = stoi(info[YEAR]);
	length = stoi(info[LENGTH]);
	price = stoi(info[PRICE]);
	summary = info[SUMMARY];
	director = info[DIRECTOR];
	id = stoi(info[FILM_ID]);
	publisher_username = info[PUBLISHER];
	rate = FIRST_RATE;
	deleted = false;
	comment_id = FIRST_ID;
}

int Film::get_id()
{
	return id;
}

string Film::get_name()
{
	return name;
}

Comment* Film::find_comment(int id)
{
	for (int i = 0; i < comments.size(); i++)
		if ((comments[i]->get_id() == id) && (!comments[i]->is_deleted()))
			return comments[i];
	return NULL;
}

void Film::delete_comment(int id)
{
	find_comment(id)->change_delete_stat();
}

void Film::reply_comment(int id, string content)
{
	find_comment(id)->add_reply(content);
}

void Film::edit_info(map<string, string> info)
{
	for (map<string, string>::iterator it = info.begin(); it != info.end(); ++it)
	{
		if (it->first == NAME)
			name = it->second;
		else if (it->first == YEAR)
			year = stoi(it->second);
		else if (it->first == LENGTH)
			length = stoi(it->second);
		else if (it->first == SUMMARY)
			summary = it->second;
		else if (it->first == DIRECTOR)
			director = it->second;
	}
}

FilmInfo Film::set_info()
{
	FilmInfo film_info;
	film_info.id = id;
	film_info.name = name;
	film_info.length = length;
	film_info.price = price;
	film_info.rate = rate;
	film_info.year = year;
	film_info.director = director;
	film_info.summary = summary;
	return film_info;
}

bool Film::is_in_range(map<string, string> info)
{
	for (map<string, string>::iterator it = info.begin(); it != info.end(); ++it)
	{
		if (it->first == NAME)
		{
			if (it->second != name)
				return false;
		}
		else if (it->first == MINRATE)
		{
			if (rate < stof(it->second))
				return false;
		}
		else if (it->first == MINYEAR)
		{
			if (year < stoi(it->second))
				return false;
		}
		else if (it->first == MAXYEAR)
		{
			if (year > stoi(it->second))
				return false;
		}
		else if (it->first == PRICE)
		{
			if (price != stoi(it->second))
				return false;
		}
		else if (it->first == DIRECTOR)
		{
			if (director != it->second)
				return false;
		}
	}
	return true;
}

bool Film::is_deleted()
{
	return deleted;
}

string Film::add_new_rate(int score, string username)
{
	scores[username] = score;
	rate = calc_rate();
	return publisher_username;
}

int Film::get_new_comment_id()
{
	comment_id++;
	return comment_id;
}

string Film::add_new_comment(string content, string writer)
{
	Comment* new_comment = new Comment(get_new_comment_id(), writer, content);
	comments.push_back(new_comment);
	return publisher_username;
}

void Film::change_delete_stat()
{
	deleted = true;
}

int Film::get_price()
{
	return price;
}

string Film::get_publisher_username()
{
	return publisher_username;
}

float Film::get_rate()
{
	return rate;
}

vector<CommentInfo> Film::get_comments_info()
{
	vector<CommentInfo> comments_info;
	for (int i = 0; i < comments.size(); i++)
		if (!comments[i]->is_deleted())
			comments_info.push_back(comments[i]->set_info());
	return comments_info;
}

int Film::get_year()
{
	return year;
}

float Film::calc_rate()
{
	int temp_rate = 0;
	for (map<string, int>::iterator it = scores.begin(); it != scores.end(); ++it)
		temp_rate += it->second;
	float _temp = temp_rate;
	return _temp / scores.size();
}#include "Manager.h"

int main()
{
	Manager manager;
	manager.run();
}#include <iostream>
#include "CommandHandler.h"
#include "Manager.h"
#include "Exceptions.h"
#include "CommandParser.h"

using namespace std;

Manager::Manager()
{
	command_handler = new CommandHandler();
	command_parser = new CommandParser;
}

void Manager::run()
{
	string input;
	while (getline(cin, input))
	{
		try
		{
			curr_command = command_parser->parse_command(input);
			command_handler->handle_command(curr_command);
		} catch (exception& exception)
		{
			cout << exception.what() << endl;
		}
	}
}#include <algorithm>
#include <iostream>
#include <iomanip>
#include "Printer.h"
#include "Film.h"

using namespace std;

void Printer::print_success_message()
{
	cout << OK << endl;
}

bool compare_by_user_id(const FollowersInfo& num1, const FollowersInfo& num2)
{
	return num1.user_id < num2.user_id;
}

void Printer::print_followers(vector<FollowersInfo> followers)
{
	sort(followers.begin(), followers.end(), compare_by_user_id);
	cout << "List of Followers" << endl;
	cout << "#. User Id | User Username | User Email" << endl;
	for (int i = 0; i < followers.size(); i++)
	{
		cout << i + 1 << ". " << followers[i].user_id << " | " << followers[i].username << " | "
			<< followers[i].email << endl;
	}
}

bool compare_by_film_id(const FilmInfo& num1, const FilmInfo& num2)
{
	return num1.id < num2.id;
}

void Printer::print_films(vector<FilmInfo> films)
{
	sort(films.begin(), films.end(), compare_by_film_id);
	cout << 
		"#. Film Id | Film Name | Film Length | Film price | Rate | Production Year | Film Director"
		<< endl;
	for (int i = 0; i < films.size(); i++)
	{
		cout << i + 1 << ". " << films[i].id << " | " << films[i].name << " | " << films[i].length <<
			" | " << films[i].price << " | " << setprecision(2) << films[i].rate << " | " << films[i].year <<
			" | " << films[i].director << endl;
	}
}

void Printer::print_notifs(vector<string> notifs)
{
	cout << "#. Notification Message" << endl;
	for (int i = notifs.size() - 1; i >= 0; i--)
		cout << notifs.size() - i << ". " << notifs[i] << endl;
}

void Printer::print_read_notifs(vector<string> notifs, int limit)
{
	if (limit > notifs.size())
		limit = notifs.size();
	int size = notifs.size();
	cout << "#. Notification Message" << endl;
	for (int i = size - 1; i >= (size - limit); i--)
		cout << size - i << ". " << notifs[i] << endl;
}

void Printer::print_film_details(Film* film)
{
	FilmInfo info = film->set_info();
	cout << "Details of Film " << info.name << endl;
	cout << "Id = "<< info.id << endl << "Director = " << info.director << endl << "Length = "  << 
		info.length << endl << "Year = " << info.year << endl << "Summary = " <<
		info.summary << endl << "Rate = " << setprecision(2) << info.rate <<
		endl << "Price = " << info.price << endl << endl;

	vector<CommentInfo> comments = film->get_comments_info();
	cout << "Comments" << endl;
	for (int i = 0; i < comments.size(); i++)
	{
		cout << comments[i].id << ". " << comments[i].content << endl;
		for(int j = 0; j < comments[i].replies.size(); j++)
			cout << comments[i].id << "." << j + 1 << ". " << comments[i].replies[j] << endl;
	}
	cout << endl;
}

void Printer::print_recommend_films(vector<FilmInfo> recommends)
{
	cout << "Recommendation Film" << endl <<
		"#. Film Id | Film Name | Film Length | Film Director" << endl;
	for (int i = 0; i < recommends.size(); i++)
		cout << i + 1 << ". " << recommends[i].id << " | " << recommends[i].name << " | " <<
			recommends[i].length << " | " << recommends[i].director << endl;
}#include <iostream>
#include <sstream>
#include "Exceptions.h"
#include "Publisher.h"
#include "Film.h"
#include "Comment.h"

using namespace std;

Publisher::Publisher(map<string, string> info)
 : User(info)
 {
 	debt_money = 0;
 }

Film* Publisher::add_film(map<string, string> info)
{
	info[PUBLISHER] = username;
	Film* new_film = new Film(info);
	published_films.push_back(new_film);
	send_add_film_notif();
	return new_film;
}

User* Publisher::find_follower(string username)
{
	for (int i = 0; i < followers.size(); i++)
		if (followers[i]->get_username() == username)
			return followers[i];
}

vector<FollowersInfo> Publisher::get_followers()
{
	vector<FollowersInfo> followers_info;
	FollowersInfo follower;
	for (int i = 0; i < followers.size(); i++)
	{
		follower.user_id = followers[i]->get_id();
		follower.username = followers[i]->get_username();
		follower.email = followers[i]->get_email();
		followers_info.push_back(follower);
	}
	return followers_info;
}

Film* Publisher::find_published_film(int id)
{
	for (int i = 0; i < published_films.size(); i++)
		if ((published_films[i]->get_id() == id) && (!published_films[i]->is_deleted()))
			return published_films[i];
	return NULL;
}

Film* Publisher::find_published_film(string film_name)
{
	for (int i = 0; i < published_films.size(); i++)
		if ((published_films[i]->get_name() == film_name) && (!published_films[i]->is_deleted()))
			return published_films[i];
	return NULL;
}

void Publisher::delete_comment(int film_id, int comment_id)
{
	find_published_film(film_id)->delete_comment(comment_id);
}

void Publisher::reply_comment(map<string, string> info)
{
	find_published_film(stoi(info[FILM_ID]))->reply_comment(stoi(info[COMMENT_ID]), info[CONTENT]);
	stringstream notif;
	notif << "Publisher " << username << " with id " << id << " reply to your comment.";
	string comment_writer = find_published_film(stoi(info[FILM_ID]))->
		find_comment(stoi(info[COMMENT_ID]))->get_writer();
	find_follower(comment_writer)->add_new_notif(notif.str());
}

void Publisher::delete_film(int id)
{
	find_published_film(id)->change_delete_stat();
}

void Publisher::edit_film(map<string, string> info)
{
	find_published_film(stoi(info[FILM_ID]))->edit_info(info);
}

vector<FilmInfo> Publisher::get_published_films(map<string, string> info)
{
	vector<FilmInfo> films_info;
	for (int i = 0; i < published_films.size(); i++)
		if (published_films[i]->is_in_range(info) && (!published_films[i]->is_deleted()))
			films_info.push_back(published_films[i]->set_info());
	return films_info;
}

void Publisher::send_add_film_notif()
{
	stringstream notif;
	notif << "Publisher " << username << " with id " << id << " register new film.";
	for (int i = 0; i < followers.size(); i++)
		followers[i]->add_new_notif(notif.str());
}

void Publisher::increase_debt(int film_price, int film_rate)
{
	if (film_rate < LOW_RATE)
		debt_money += 0.8 * film_price;
	else if (film_rate >= HIGH_RATE)
		debt_money += 0.95 * film_price;
	else
		debt_money += 0.9 * film_price;
}

int Publisher::get_money_from_network()
{
	int temp = debt_money;
	money += debt_money;
	debt_money = 0;
	return temp;
}

void Publisher::add_follower(User* new_follower)
{
	followers.push_back(new_follower);
}#include <algorithm>
#include "User.h"
#include "Data.h"
#include "Recommender.h"
#include "Film.h"

using namespace std;

Recommender::Recommender(Data* _data)
{
	data = _data;
}

bool compare_by_rate(Film* num1, Film* num2)
{
	if (num1->get_rate() == num2->get_rate())
		return num1->get_year() > num2->get_year();
	return num1->get_rate() < num2->get_rate();
}

vector<FilmInfo> Recommender::recommend_film(User* user, Film* curr_film)
{
	film = curr_film;
	curr_user = user;
	films = data->get_films();
	sort(films.begin(), films.end(), compare_by_rate);
	return find_recommendation_films();
}

vector<FilmInfo> Recommender::find_recommendation_films()
{
	vector<FilmInfo> recommendation_films;
	for (int i = films.size() - 1; i >= 0; i--)
	{
		if (recommendation_films.size() == NUM_OF_RECOMMENDED_FILMS)
			return recommendation_films;
		if ((curr_user->find_film(films[i]->get_id()) == NULL) && (!films[i]->is_deleted()) &&
			(films[i] != film))
			recommendation_films.push_back(films[i]->set_info());
	}
	return recommendation_films;
}#include <sstream>
#include "User.h"
#include "Publisher.h"
#include "Film.h"
#include "Comment.h"

using namespace std;

User::User(map<string, string> info)
{
	username = info[USERNAME];
	password = info[PASSWORD];
	email = info[EMAIL];
	age = stoi(info[AGE]);
	id = stoi(info[USER_ID]);
	if (info[PUBLISHER] == _TRUE)
		publisher = true;
	else
		publisher = false;
	money = 0;
}

string User::get_username()
{
	return username;
}

string User::get_email()
{
	return email;
}

int User::get_id()
{
	return id;
}

bool User::check_password(string pass)
{
	return pass == password;
}

bool User::is_publisher()
{
	return publisher;
}

Publisher* User::find_publisher(string publisher_name)
{
	for (int i = 0; i < following.size(); i++)
		if (following[i]->get_username() == publisher_name)
			return following[i];
	return NULL;
}

Film* User::find_film(int id)
{
	for (int i = 0; i < bought_films.size(); i++)
		if ((bought_films[i]->get_id() == id) && (!bought_films[i]->is_deleted()))
			return bought_films[i];
	return NULL;
}

void User::add_new_notif(string notif)
{
	unread_notifs.push_back(notif);
}

bool User::follow(Publisher* publisher)
{
	if (find_publisher(publisher->get_username()) == NULL)
	{
		following.push_back(publisher);
		publisher->add_follower(this);
		return true;
	}
	return false;
}

void User::rate_film(int film_id, int score)
{
	stringstream notif;
	notif << "User " << username << " with id " << id << " rate your film " <<
		find_film(film_id)->get_name() << " with id " << film_id << ".";
	string publisher = find_film(film_id)->add_new_rate(score, username);
	find_publisher(publisher)->add_new_notif(notif.str());
}

void User::comment(int film_id, string content)
{
	stringstream notif;
	notif << "User " << username << " with id " << id << " comment on your film " <<
		find_film(film_id)->get_name() << " with id " << film_id << ".";
	string publisher_name = find_film(film_id)->add_new_comment(content, username);
	find_publisher(publisher_name)->add_new_notif(notif.str());
}

void User::charge_account(int amount)
{
	money += amount;
}

bool User::check_can_buy_film(int film_price)
{
	if (film_price > money)
		return false;
	return true;
}

string User::buy_new_film(Film* new_film)
{
	if (find_film(new_film->get_id()) == NULL)
	{
		bought_films.push_back(new_film);
		money -= new_film->get_price();
		stringstream notif;
		notif << "User " << username << " with id " << id << " buy your film " << new_film->get_name() <<
			" with id " << new_film->get_id() << ".";
		return notif.str();
	}
	return EMPTY_STRING;
}

vector<FilmInfo> User::get_bought_films(map<string, string> info)
{
	vector<FilmInfo> films_info;
	for (int i = 0; i < bought_films.size(); i++)
		if (bought_films[i]->is_in_range(info) && (!bought_films[i]->is_deleted()))
			films_info.push_back(bought_films[i]->set_info());
	return films_info;
}

vector<string> User::get_notifs()
{
	vector<string> temp = unread_notifs;
	transfer_unread_notifs_to_read();
	return temp;
}

vector<string> User::get_read_notifs()
{
	return read_notifs;
}

void User::transfer_unread_notifs_to_read()
{
	for (int i = 0; i < unread_notifs.size(); i++)
		read_notifs.push_back(unread_notifs[i]);
	unread_notifs.clear();
}#ifndef COMMANDHANDLER_H
#define COMMANDHANDLER_H

#include <string>
#include <map>
#include <vector>
#include "define.h"

class Controller;
class Data;
class Printer;
class Recommender;

class CommandHandler
{
private:
	Printer* printer;
	Data* data;
	Controller* controller;
	Recommender* recommender;
	std::map<std::string, std::string> curr_command;
	void handle_post_commands();
	void handle_put_commands();
	void handle_delete_commands();
	void handle_get_commands();
	void handle_post_money_commands();
	void handle_get_films_commands();
	void signup();
	void login();
	void add_film();
	void reply();
	void follow();
	void rate();
	void comment();
	void charge_account();
	void edit_film();
	void delete_film();
	void delete_comment();
	void buy();
	void get_money_from_network();
	std::vector<FollowersInfo> get_followers();
	std::vector<FilmInfo> get_published_films();
	std::vector<FilmInfo> get_bought_films();
	std::vector<std::string> get_notifs();
	std::vector<std::string> get_read_notifs();
	std::vector<FilmInfo> search();
public:
	CommandHandler();
	void handle_command(std::map<std::string, std::string> _curr_command);
};

#endif#ifndef COMMANDPARSER_H
#define COMMANDPARSER_H

#include <vector>
#include <string>
#include <map>

class CommandParser
{
private:
	std::map<std::string, std::string> change_vector_to_map(std::vector<std::string> vector);
public:
	std::map<std::string, std::string> parse_command(std::string command);
};


#endif#ifndef COMMENT_H
#define COMMENT_H

#include <string>
#include <vector>
#include "define.h"

class Comment
{
private:
	int id;
	std::string writer;
	std::string content;
	std::vector<std::string> replies;
	bool deleted;
public:
	Comment(int _id, std::string _writer, std::string _content);
	int get_id();
	std::string get_writer();
	bool is_deleted();
	void add_reply(std::string reply_message);
	void change_delete_stat();
	CommentInfo set_info();
};

#endif#ifndef CONTROLLER_H
#define CONTROLLER_H

#include <map>
#include <string>

class Data;

class Controller
{
private:
	Data* data;
	void does_user_have_the_film(int film_id);
	void check_search_films_optional_datas(std::map<std::string, std::string> command);
	void check_edit_film_optional_datas(std::map<std::string, std::string> command);
	void check_get_bought_films_optional_datas(std::map<std::string, std::string> command);
	void check_validataion_of_email(std::string email);
	void check_if_number(std::string str);
public:
	Controller(Data* _data);
	void control_signup(std::map<std::string, std::string> command);
	void control_login(std::map<std::string, std::string> command);
	void control_add_film(std::map<std::string, std::string> command);
	void control_reply(std::map<std::string, std::string> command);
	void control_follow(std::map<std::string, std::string> command);
	void control_rate(std::map<std::string, std::string> command);
	void control_comment(std::map<std::string, std::string> command);
	void control_delete_film(std::map<std::string, std::string> command);
	void control_edit_film(std::map<std::string, std::string> command);
	void control_delete_comment(std::map<std::string, std::string> command);
	void control_get_followers(std::map<std::string, std::string> command);
	void control_get_published_films(std::map<std::string, std::string> command);
	void control_get_bought_films(std::map<std::string, std::string> command);
	void control_get_notifs(std::map<std::string, std::string> command);
	void control_get_read_notifs(std::map<std::string, std::string> command);
	void control_get_money_from_network(std::map<std::string, std::string> command);
	void control_charge_account(std::map<std::string, std::string> command);
	void control_show_film_details(std::map<std::string, std::string> command);
	void control_search(std::map<std::string, std::string> command);
	void control_buy(std::map<std::string, std::string> command);
};

#endif#ifndef DATA_H
#define DATA_H

#include <vector>
#include <string>
#include <map>
#include "define.h"

class User;
class Film;
class Publisher;

class Data
{
private:
	std::vector<User*> users;
	std::vector<Film*> films;
	int user_id;
	int film_id;
	User* active_user;
	int network_money;
public:
	Data();
	User* find_user(std::string username);
	User* find_user(int id);
	Film* find_film(int id);
	User* get_active_user();
	std::vector<Film*> get_films();
	int get_new_user_id();
	int get_new_film_id();
	void change_active_user(User* new_active_user);
	void add_new_user(User* new_user);
	void add_new_film(Film* new_film);
	User* increase_network_money(int film_id);
	void decrease_network_money(int money);
	std::vector<FilmInfo> search(std::map<std::string, std::string> info);
};

#endif#ifndef DEFINE_H
#define DEFINE_H

#include <string>
#include <vector>

struct FollowersInfo
{
	int user_id;
	std::string username;
	std::string email;
};

struct FilmInfo
{
	int id;
	std::string name;
	int length;
	int price;
	float rate;
	int year;
	std::string director; 
	std::string summary;
};

struct  CommentInfo
{
	int id;
	std::string content;
	std::vector<std::string> replies;
};

#define NOTFOUND "Not Found"
#define BADREQUEST "Bad Request"
#define PERMISSIONDENIED "Permission Denied"
#define FIRST_ID 0
#define FIRST_RATE 0
#define NAME "name"
#define YEAR "year"
#define LENGTH "length"
#define SUMMARY "summary"
#define DIRECTOR "director"
#define USERNAME "username"
#define MINRATE "min_rate"
#define MINYEAR "min_year"
#define MAXYEAR "max_year"
#define PRICE "price"
#define QUESTION_MARK "?"
#define SPACE ' '
#define POST "POST"
#define PUT "PUT"
#define DELETE "DELETE"
#define GET "GET"
#define READ "read"
#define NOTIFS "notifications"
#define OK "OK"
#define SIGNUP "signup"
#define LOGIN "login"
#define FILMS "films"
#define MONEY "money"
#define REPLIES "replies"
#define FOLLOWERS "followers"
#define BUY "buy"
#define RATE "rate"
#define COMMENTS "comments"
#define PUBLISHED "published"
#define PURCHASED "purchased"
#define READ_NOTIFS "notificationsread"
#define PASSWORD "password"
#define EMAIL "email"
#define AGE "age"
#define FILM_ID "film_id"
#define COMMENT_ID "comment_id"
#define CONTENT "content"
#define USER_ID "user_id"
#define SCORE "score"
#define MIN_SCORE 1
#define MAX_SCORE 10
#define LIMIT "limit"
#define PUBLISHER "publisher"
#define _TRUE "true"
#define _FALSE "false"
#define AT '@'
#define DOT '.'
#define AMOUNT "amount"
#define ASCII_ZERO '0'
#define ASCII_NINE '9'
#define HIGH_RATE 8
#define LOW_RATE 5
#define EMPTY_STRING ""
#define NUM_OF_RECOMMENDED_FILMS 4

#endif#ifndef EXCEPTIONS_H
#define EXCEPTIONS_H

#include <exception>

class NotFound : public std::exception
{
public:
	virtual const char* what() const throw();
};

class BadRequest : public std::exception
{
public:
	virtual const char* what() const throw();
};

class PermissionDenied : public std::exception
{
public:
	virtual const char* what() const throw();
};

#endif#ifndef FILM_H
#define FILM_H

#include <string>
#include <vector>
#include <map>
#include "define.h"

class Comment;

class Film
{
private:
	std::string name;
	int year;
	int length;
	int price;
	std::string summary;
	std::string director;
	float rate;
	int id;
	bool deleted;
	int comment_id;
	std::map<std::string, int> scores;
	std::string publisher_username;
	std::vector<Comment*> comments;
	float calc_rate();
public:
	Film(std::map<std::string, std::string> info);
	int get_id();
	std::string get_name();
	int get_price();
	float get_rate();
	int get_year();
	std::string get_publisher_username();
	int get_new_comment_id();
	Comment* find_comment(int id);
	void delete_comment(int id);
	void reply_comment(int id, std::string content);
	void edit_info(std::map<std::string, std::string> info);
	FilmInfo set_info();
	bool is_in_range(std::map<std::string, std::string> info);
	bool is_deleted();
	std::string add_new_rate(int score, std::string username);
	std::string add_new_comment(std::string content, std::string writer);
	void change_delete_stat();
	std::vector<CommentInfo> get_comments_info();
};

#endif#ifndef MANAGER_H
#define MANAGER_H

#include <vector>
#include <string>
#include <map>

class CommandHandler;
class Data;
class CommandParser;
class Printer;

class Manager
{
private:
	CommandHandler* command_handler;
	CommandParser* command_parser;
	std::map<std::string, std::string> curr_command;
public:
	Manager();
	void run();
};

#endif#ifndef PRINTER_H
#define PRINTER_H

#include <vector>
#include <string>
#include "define.h"

class Film;

class Printer
{
public:
	void print_success_message();
	void print_followers(std::vector<FollowersInfo> followers);
	void print_films(std::vector<FilmInfo> films);
	void print_notifs(std::vector<std::string> notifs);
	void print_read_notifs(std::vector<std::string> notifs ,int limit);
	void print_film_details(Film* film);
	void print_recommend_films(std::vector<FilmInfo> recommends);
};

#endif#ifndef PUBLISHER_H
#define PUBLISHER_H

#include <vector>
#include <string>
#include <map>
#include "User.h"
#include "define.h"

class Film;

class Publisher : public User
{
private:
	std::vector<Film*> published_films;
	std::vector<User*> followers;
	int debt_money;
	User* find_follower(std::string username);
public:
	Publisher(std::map<std::string, std::string> info);
	Film* find_published_film(int id);
	Film* find_published_film(std::string film_name);
	void add_follower(User* new_follower);
	Film* add_film(std::map<std::string, std::string> info);
	void edit_film(std::map<std::string, std::string> info);
	void delete_film(int id);
	void reply_comment(std::map<std::string, std::string> info);
	void delete_comment(int film_id, int comment_id);
	void send_add_film_notif();
	void increase_debt(int film_price, int film_rate);
	int get_money_from_network();
	std::vector<FollowersInfo> get_followers();
	std::vector<FilmInfo> get_published_films(std::map<std::string, std::string> info);
};

#endif#ifndef RECOMMENDER_H
#define RECOMMENDER_H

#include "define.h"

class Data;
class User;
class Film;

class Recommender
{
private:
	Data* data;
	User* curr_user;
	Film* film;
	std::vector<Film*> films;
	std::vector<FilmInfo> find_recommendation_films();
public:
	Recommender(Data* _data);
	std::vector<FilmInfo> recommend_film(User* user, Film* curr_film);
};

#endif#ifndef USER_H
#define USER_H

#include "define.h"
#include <string>
#include <vector>
#include <map>

class Publisher;
class Film;
class Comment;

class User
{
protected:
	std::string username;
	std::string email;
	std::string password;
	int age;
	int id;
	bool publisher;
	std::vector<Publisher*> following;
	std::vector<Film*> bought_films;
	int money;
	std::vector<std::string> read_notifs;
	std::vector<std::string> unread_notifs;
	void transfer_unread_notifs_to_read();
public:
	User(std::map<std::string, std::string> info);
	std::string get_username();
	std::string get_email();
	int get_id();
	bool check_password(std::string pass);
	bool check_can_buy_film(int film_price);
	bool is_publisher();
	Film* find_film(int id);
	Publisher* find_publisher(std::string publisher_name);
	void add_new_notif(std::string notif);
	bool follow(Publisher* publisher);
	void comment(int film_id, std::string content);
	void charge_account(int amount);
	void rate_film(int film_id, int score);
	std::string buy_new_film(Film* new_film);
	std::vector<FilmInfo> get_bought_films(std::map<std::string, std::string> info);
	std::vector<std::string> get_notifs();
	std::vector<std::string> get_read_notifs();
};

#endif